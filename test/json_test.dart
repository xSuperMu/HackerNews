import 'dart:convert';

import 'package:flutter_test/flutter_test.dart';
import 'package:hn_app/model/article.dart';
import 'package:http/http.dart' as http;

void main() {
  test("parses topStories.json", () {
    const jsonStr =
        "[23880207,23878728,23880071,23877468,23878753,23878508,23875367,23869155,23877406,23840735,23877912,23880938,23874206,23876847,23880379,23876146,23878029,23871169,23874004,23869534,23870769,23869839,23875790,23869480,23870661,23877872,23851862,23868355,23878688,23875636,23875758,23880166,23875419,23880878,23871367,23858662,23879034,23880295,23880399,23878954,23875692,23868206,23867892,23874337,23869665,23873752,23849992,23869752,23865484,23869974,23870171,23877364,23871907,23870434,23864934,23869532,23864265,23869349,23880167,23870066,23872625,23870339,23878741,23872019,23868493,23860338,23870240,23864793,23871710,23879370,23866764,23877355,23875418,23878338,23868119,23858294,23859180,23870595,23880065,23871859,23866894,23870622,23866678,23869819,23875179,23865116,23868756,23877560,23865900,23853786,23842656,23870507,23860779,23878997,23857072,23841491,23851275,23871798,23872227,23867490,23869858,23863322,23872873,23861435,23870521,23870164,23874571,23855884,23866688,23871126,23877869,23872934,23865343,23870048,23873348,23865595,23858598,23872333,23866364,23857654,23867402,23861090,23862903,23879879,23860659,23846186,23864909,23848039,23835918,23877144,23849202,23863505,23879129,23833140,23833362,23877615,23867172,23863483,23870282,23865674,23859985,23859085,23875541,23866874,23870269,23859448,23862471,23859548,23862059,23864247,23859278,23860362,23856918,23868295,23856988,23877337,23841880,23863654,23878859,23865869,23851205,23872491,23840295,23855082,23856044,23870693,23843145,23856086,23872719,23871601,23858590,23870283,23833441,23840787,23878536,23851200,23858008,23858916,23870489,23859401,23877780,23834153,23878666,23852754,23855722,23878197,23858764,23839895,23860281,23855539,23851006,23855806,23855743,23851892,23862189,23875235,23856229,23837109,23880107,23840364,23851870,23861547,23878328,23871603,23872184,23877494,23872723,23861328,23851864,23868037,23868759,23868744,23870258,23860701,23870461,23837824,23844490,23860584,23850718,23863903,23860568,23877075,23843813,23855477,23837838,23872636,23874937,23854222,23854329,23838124,23843434,23851542,23852036,23850831,23841011,23869592,23841539,23872612,23865995,23846026,23876213,23869338,23855967,23863719,23858425,23839271,23845579,23843485,23837341,23862640,23861396,23868981,23865446,23852012,23873411,23843525,23875676,23873223,23855061,23868646,23847993,23868601,23844177,23860981,23868397,23845020,23858234,23833429,23846203,23869741,23849005,23836395,23880013,23872898,23871471,23874323,23866470,23836578,23867932,23859622,23839480,23836561,23853239,23867553,23865296,23878444,23854292,23874108,23839973,23873974,23875031,23839390,23860497,23877173,23847116,23842179,23877123,23860829,23845575,23859677,23864090,23837251,23874447,23846103,23839023,23855363,23839371,23840670,23858494,23878058,23869528,23844643,23838564,23846654,23866049,23867158,23852793,23841409,23843965,23875842,23842137,23838625,23865396,23849784,23837640,23839407,23841049,23836616,23840239,23872933,23864427,23850316,23844648,23850874,23859521,23859519,23869006,23872214,23856479,23866768,23858763,23840619,23867413,23869804,23867293,23838264,23836386,23853013,23836808,23868539,23871186,23874075,23861676,23864796,23836679,23868269,23851393,23873772,23840243,23870607,23849757,23844267,23859231,23848977,23869439,23848692,23859456,23860750,23877270,23859904,23839212,23856611,23839691,23877381,23839384,23877295,23860200,23833267,23861763,23845580,23834897,23852472,23868645,23848512,23859553,23862634,23834483,23837269,23872349,23871934,23836985,23858887,23844370,23841964,23836321,23872157,23854908,23840176,23873425,23873385,23851696,23858155,23871370,23860257,23874314,23863208,23846845,23866143,23857849,23853165,23833150,23835899,23839127,23849070,23853424,23849072,23858594,23849221,23859996,23876515,23864321,23864313,23851523,23869442,23846061,23857020,23869353,23868171,23842575,23862718,23859751,23855180,23843357,23873505,23857540,23850899,23853314,23859489,23838565,23852157,23851438,23864933,23868389,23854330,23868311,23850641,23856997,23868230,23843711,23858072,23850078,23863116,23842589,23859508,23848181,23836049,23867817,23862457,23853719,23857294,23865239,23871373,23838800,23861392,23848594,23838850,23838016,23837913,23843161,23873778,23849889,23873676,23854718,23857372,23859457,23863408,23835163,23842847,23844690,23841165,23848299,23862781,23862735,23850163,23868713,23862565,23859547,23849023,23866022,23855741,23843296,23865657,23833338,23846091,23855777,23865422,23849566,23865285,23839312,23859708]";
    expect(parseTopStories(jsonStr).first, 23880207);
  });

  test("parses item.json", () {
    const jsonStr =
        """{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8917,8952,8884,8887,8869,8958,8940,8908,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}""";

    expect(parseArticle(jsonStr).by, "dhouston");
  });

  test("parses item.json over a network", () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final res = await http.get(url);
    if (res.statusCode == 200) {
      final idList = parseTopStories(res.body);
      if (idList.isNotEmpty) {
        final storyUrl =
            'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';
        final storyRes = await http.get(storyUrl);
        if (storyRes.statusCode == 200) {
          expect(parseArticle(storyRes.body), isNotNull);
        }
      }
    }
  }, skip: true);
}
